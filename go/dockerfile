FROM golang:alpine AS build

WORKDIR /app
ENV CGO_ENABLED=1
ENV CGO_CFLAGS="-D_LARGEFILE64_SOURCE"

RUN apk add --no-cache \
    # Important: required for go-sqlite3
    gcc \
    # Required for Alpine
    musl-dev \
    # SQLite3 headers and library
    sqlite-dev

COPY go.mod ./
COPY go.sum ./
RUN go mod download

COPY smsq/*.* ./

RUN go build -o /smsq-backend


FROM alpine:latest

WORKDIR /

COPY --from=build /app/pk.json /
COPY --from=build /app/config.json /
COPY --from=build /smsq-backend /
RUN apk add --no-cache libc6-compat
RUN apk add --no-cache gcompat

EXPOSE 80


CMD ["./smsq-backend", "config.json" ]